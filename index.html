<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Wallet - Premium Earning</title>
    
    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1067/1067566.png">

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-bg: #f0f2f5;
            --card-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --accent-color: #00d2ff;
            --text-dark: #333;
            --text-light: #888;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            background: #dfe6e9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overscroll-behavior-y: contain;
        }

        /* Mobile Container */
        .app-container {
            width: 100%;
            max-width: 414px;
            background: var(--primary-bg);
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }

        @media (min-width: 420px) {
            .app-container {
                height: 850px;
                border-radius: 25px;
                border: 5px solid #fff;
            }
        }

        /* Header */
        .header-nav {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-title { font-weight: 700; font-size: 18px; color: var(--text-dark); }

        /* Screens */
        .screen { display: none; animation: slideIn 0.3s ease-out; padding-bottom: 80px; }
        .active-screen { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- WALLET CARD DESIGN --- */
        .wallet-card {
            margin: 20px;
            padding: 25px;
            border-radius: 25px;
            background: linear-gradient(120deg, #152e5a 0%, #2a5298 60%, #00d2ff 100%); /* Default Blue */
            color: white;
            box-shadow: 0 15px 35px rgba(30, 60, 114, 0.4);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.15);
            transition: background 0.5s ease;
        }
        
        /* Dynamic Backgrounds (Applied to Wallet & Gift Cards) */
        .bg-bronze { background: linear-gradient(135deg, #d38312 0%, #a83279 100%) !important; }
        .bg-silver { background: linear-gradient(135deg, #434343 0%, #000000 100%) !important; }
        .bg-gold   { background: linear-gradient(135deg, #f12711 0%, #f5af19 100%) !important; }
        .bg-platinum { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%) !important; }
        .bg-diamond { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%) !important; }

        /* Circles for design */
        .wallet-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 180px; height: 180px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            z-index: 1;
        }
        .wallet-card::after {
            content: ''; position: absolute; bottom: -30px; left: -30px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            z-index: 1;
        }
        
        .wallet-content {
            position: relative;
            z-index: 2;
        }

        .balance-label { 
            font-size: 12px; 
            opacity: 0.9; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: #dbeeff;
        }
        .balance-amount { 
            font-size: 40px; 
            font-weight: 700; 
            margin: 5px 0 15px 0; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .user-info-pill {
            background: rgba(255,255,255,0.15);
            padding: 6px 14px; border-radius: 20px;
            font-size: 11px; display: inline-flex; align-items: center; gap: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 500;
        }
        
        .card-chip {
            font-size: 35px;
            color: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
        }
        /* --- END DESIGN --- */

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 0 20px;
            margin-bottom: 20px;
        }
        .action-item {
            background: white;
            padding: 15px 5px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            transition: 0.2s; cursor: pointer;
        }
        .action-item:active { transform: scale(0.95); }
        .action-icon {
            width: 45px; height: 45px;
            background: #eef2f5;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 8px auto;
            font-size: 18px; color: #1e3c72;
        }
        .action-text { font-size: 11px; font-weight: 600; color: #555; }

        /* Forms */
        .auth-container { padding: 30px; margin-top: 40px; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group i.fa-icon { position: absolute; left: 15px; top: 16px; color: #1e3c72; }
        .input-group .toggle-pass { position: absolute; right: 15px; top: 16px; color: #888; cursor: pointer; }
        
        input, select {
            width: 100%; padding: 14px 40px 14px 45px;
            border: 1px solid #eee; border-radius: 12px;
            background: white; font-size: 14px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        
        button.btn-main {
            width: 100%; padding: 15px;
            background: var(--card-gradient);
            color: white; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
            margin-top: 10px;
            transition: 0.3s;
        }
        button.btn-outline {
            width: 100%; padding: 12px;
            background: transparent;
            color: #1e3c72; border: 1px solid #1e3c72; border-radius: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            margin-top: 10px;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Lists (History & Team) */
        .list-container { padding: 0 20px; }
        .list-item {
            background: white; padding: 15px; border-radius: 15px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.02);
        }
        .list-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 15px;
        }
        .deposit-icon { background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .withdraw-icon { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .team-icon { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .rank-badge { 
            width: 30px; height: 30px; background: #1e3c72; color: #fff; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
        }

        /* Tabs */
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; padding: 0 20px; }
        .tab-btn { padding: 10px 25px; border: 1px solid #1e3c72; border-radius: 25px; background: none; color: #1e3c72; margin: 0 5px; cursor: pointer; font-size: 13px; transition: 0.3s; }
        .tab-btn.active { background: #1e3c72; color: white; box-shadow: 0 4px 10px rgba(30, 60, 114, 0.3); }

        /* --- PREMIUM BANNER CARDS (NEW 2.0 STYLE) --- */
        .gift-card {
            border-radius: 20px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            min-height: 110px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: white;
            transition: transform 0.2s;
            background: #333; /* Default fallback */
        }
        .gift-card:active { transform: scale(0.98); }

        /* Faded Background Icon */
        .card-bg-icon {
            position: absolute;
            right: -15px;
            bottom: -20px;
            font-size: 100px;
            opacity: 0.15;
            transform: rotate(-10deg);
            z-index: 0;
            pointer-events: none;
        }

        .gift-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .gift-title { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .gift-subtitle { font-size: 11px; opacity: 0.9; margin-top: 2px; }
        
        .card-badge {
            background: rgba(255,255,255,0.25);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 10px;
            backdrop-filter: blur(5px);
            margin-top: 5px;
            display: inline-block;
        }

        /* Buttons inside Card */
        .btn-card-action {
            background: white;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            min-width: 90px;
        }
        .btn-card-action.locked {
            background: rgba(0,0,0,0.4);
            color: rgba(255,255,255,0.8);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-card-action.pending {
            background: #FF9800;
            color: white;
        }
        .btn-card-action.done {
            background: #4CAF50;
            color: white;
        }

        /* --- END NEW CARD DESIGN --- */

        /* --- NEW LEADERBOARD STYLES (STICKY FOOTER) --- */
        .leader-scroll-area {
            padding-bottom: 80px; /* Ensure last item is not hidden */
        }
        .sticky-rank-footer {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px; /* Matches app container */
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 12px 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            z-index: 100;
            display: none; /* Hidden by default */
            justify-content: space-between;
            align-items: center;
        }
        /* --- END LEADERBOARD STYLES --- */

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 85%; max-width: 350px;
            margin: 20% auto; padding: 25px; border-radius: 25px;
            text-align: center; animation: popUp 0.3s;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* AD POPUP SPECIFIC STYLE */
        .ad-modal-content {
            background: white;
            width: 340px; 
            padding: 10px;
            border-radius: 10px;
            position: relative;
            margin: 30% auto;
            text-align: center;
        }
        .close-ad-btn {
            position: absolute;
            top: -15px;
            right: -10px;
            background: red;
            color: white;
            border: 2px solid white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* Ad Containers */
        .banner-box {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            min-height: 250px;
        }

        /* Special Pages */
        .special-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 30px;
        }
        .special-icon { font-size: 60px; margin-bottom: 20px; color: #1e3c72; }

        /* Profile Styles */
        .profile-header {
            text-align: center; padding: 20px; background: white; margin-bottom: 15px; border-radius: 0 0 25px 25px;
        }
        .profile-avatar {
            width: 80px; height: 80px; background: #eef2f5; border-radius: 50%; margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center; font-size: 30px; color: #1e3c72;
            border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .copy-box {
            background: #eef2f5; padding: 10px; border-radius: 10px; display: flex; 
            justify-content: space-between; align-items: center; margin-top: 10px;
            font-family: monospace; font-size: 13px;
        }

        /* Utility */
        .btn-text { background: none; border: none; color: #1e3c72; cursor: pointer; font-weight: 600; margin-top: 15px; }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- SPECIAL PAGES -->
    <div id="no-internet" class="special-page">
        <i class="fas fa-wifi special-icon" style="color: var(--danger);"></i>
        <h2>No Internet</h2>
        <p>Please check your connection.</p>
        <!-- UPDATED BUTTON: Calls JS function instead of location.reload() -->
        <button class="btn-main" id="btn-retry-net" onclick="checkInternetManual()">Retry</button>
    </div>
    
    <div id="maintenance-page" class="special-page">
        <i class="fas fa-tools special-icon" style="color: var(--warning);"></i>
        <h2>Maintenance</h2>
        <p>App is currently under maintenance.<br>Please try again later.</p>
    </div>

    <div id="blocked-page" class="special-page">
        <i class="fas fa-ban special-icon" style="color: var(--danger);"></i>
        <h2>Account Blocked</h2>
        <p>Your account has been suspended due to suspicious activity.</p>
        <button class="btn-text" onclick="openSupport()">Contact Admin</button>
    </div>

    <!-- 1. AUTH SCREEN (Login/Register) -->
    <div id="auth-screen" class="screen active-screen">
        <div style="text-align: center; padding-top: 60px;">
            <i class="fas fa-gem" style="font-size: 50px; color: #1e3c72;"></i>
            <h2 style="margin-top: 15px; color: #1e3c72;">Pro Wallet</h2>
            <p style="color: #888; font-size: 13px;">Secure & Fast Earning</p>
        </div>

        <div class="auth-container">
            <!-- Login Form -->
            <div id="login-box">
                <h3 style="margin-bottom: 20px;">Login</h3>
                <div class="input-group">
                    <i class="fas fa-envelope fa-icon"></i>
                    <input type="email" id="login-email" placeholder="Email">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock fa-icon"></i>
                    <input type="password" id="login-pass" placeholder="Password">
                    <i class="fas fa-eye toggle-pass" onclick="togglePass('login-pass')"></i>
                </div>
                <button class="btn-main" id="btn-login" onclick="loginUser()">Login</button>
                <button class="btn-text" onclick="showReg()">Create Account</button>
            </div>

            <!-- Register Form -->
            <div id="reg-box" style="display: none;">
                <h3 style="margin-bottom: 20px;">Register</h3>
                <div class="input-group"><i class="fas fa-user fa-icon"></i><input type="text" id="reg-name" placeholder="Full Name"></div>
                <div class="input-group"><i class="fas fa-envelope fa-icon"></i><input type="email" id="reg-email" placeholder="Email"></div>
                <div class="input-group">
                    <i class="fas fa-phone fa-icon"></i>
                    <input type="number" id="reg-phone" placeholder="Phone (11 digits)" 
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock fa-icon"></i>
                    <input type="password" id="reg-pass" placeholder="Password (6+ chars)">
                    <i class="fas fa-eye toggle-pass" onclick="togglePass('reg-pass')"></i>
                </div>
                <button class="btn-main" id="btn-reg" onclick="registerUser()">Register</button>
                <button class="btn-text" onclick="showLogin()">Back to Login</button>
            </div>
            <p id="auth-msg" style="color: red; text-align: center; margin-top: 10px; font-size: 12px;"></p>
        </div>
    </div>

    <!-- 1.5 NEW REFERRAL SCREEN (MANDATORY) -->
    <div id="refer-screen" class="screen">
        <div style="text-align: center; padding: 40px; margin-top: 50px;">
            <i class="fas fa-users" style="font-size: 50px; color: #1e3c72; margin-bottom: 20px;"></i>
            <h2 style="color: #333;">Join a Team</h2>
            <p style="color: #777; margin: 10px 0 30px 0; font-size: 13px;">
                Enter a valid Referral Code to continue.<br><b>Without a code, you cannot proceed.</b>
            </p>
            
            <div class="input-group">
                <i class="fas fa-code fa-icon"></i>
                <input type="text" id="final-refer-code" placeholder="Enter Referral Code" style="text-transform: uppercase;">
            </div>
            
            <button class="btn-main" id="btn-verify-ref" onclick="submitReferCode()">Verify & Continue</button>
            <button class="btn-text" onclick="logout()" style="color: red; margin-top: 20px;">Logout</button>
        </div>
    </div>

    <!-- 2. DEPOSIT PAGE (Dynamic Update) -->
    <div id="deposit-screen" class="screen">
        <div class="header-nav">
            <span class="header-title">Activate Account</span>
            <i class="fas fa-sign-out-alt" onclick="logout()" style="color: red; cursor: pointer;"></i>
        </div>
        <div style="padding: 20px;">
            <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">Membership Fee</p>
                <!-- DYNAMIC AMOUNT -->
                <h1 style="color: #1e3c72; font-size: 40px; font-weight: 700;">‡ß≥<span id="display-dep-amount">...</span></h1>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border: 1px dashed #1e3c72; border-radius: 10px;">
                    <span style="font-size: 12px; color: #888;">Send money to (Bkash/Nagad)</span>
                    <!-- DYNAMIC NUMBER -->
                    <h3 style="color: #1e3c72; margin-top: 5px; cursor:pointer;" id="display-dep-number" onclick="copyText('display-dep-number')">Loading...</h3>
                </div>
            </div>

            <h4 style="margin: 25px 0 15px 0; color: #444;">Submit Details</h4>
            <div class="input-group"><i class="fas fa-wallet fa-icon"></i>
                <select id="pay-method" style="padding-left: 45px; width: 100%; border-radius: 12px; height: 50px; border: 1px solid #eee;">
                    <option value="">Select Method</option>
                    <option value="Bkash">Bkash</option>
                    <option value="Nagad">Nagad</option>
                </select>
            </div>
            
            <div class="input-group">
                <i class="fas fa-mobile-alt fa-icon"></i>
                <input type="text" id="pay-number" placeholder="Sender Number"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)">
            </div>
            
            <div class="input-group">
                <i class="fas fa-receipt fa-icon"></i>
                <input type="text" id="pay-trx" placeholder="Transaction ID" 
                       oninput="this.value = this.value.slice(0, 10)">
            </div>
            
            <button class="btn-main" onclick="submitPayment()">Verify Payment</button>
        </div>
    </div>

    <!-- 3. PENDING PAGE (Third Step) -->
    <div id="pending-screen" class="screen">
        <div class="status-page" style="text-align: center; padding: 40px; margin-top: 50px;">
            <div style="width: 80px; height: 80px; background: rgba(241, 196, 15, 0.2); color: var(--warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 20px auto;"><i class="fas fa-hourglass-half"></i></div>
            <h2 style="color: #333;">Verification Pending</h2>
            <p style="color: #777; margin-top: 10px; line-height: 1.6;">
                Payment details received.<br>Please wait for admin approval.<br>
                <span style="font-size: 11px; color: #1e3c72;">Referral bonus will be active after approval.</span>
            </p>
            <div style="margin-top: 30px; background: white; padding: 15px; border-radius: 10px;">
                <p style="font-size: 12px; color: #aaa;">Status</p>
                <b style="color: #f1c40f;">UNDER REVIEW</b>
            </div>
            <button class="btn-text" onclick="location.reload()" style="margin-top: 40px;">Check Again</button>
            <button class="btn-text" onclick="logout()" style="color: red; display: block; width: 100%;">Logout</button>
        </div>
    </div>

    <!-- 4. DASHBOARD (Final Home Page) -->
    <div id="dashboard-screen" class="screen">
        <!-- Top Nav -->
        <div class="header-nav" style="background: transparent; box-shadow: none; padding-bottom: 0;">
            <div>
                <p style="font-size: 12px; color: #666;">Welcome back,</p>
                <h3 id="dash-name" style="color: #1e3c72;">User</h3>
            </div>
            <div onclick="openProfile()" style="background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;">
                <i class="fas fa-user-circle" style="color: #1e3c72; font-size: 20px;"></i>
            </div>
        </div>

        <!-- NEW DESIGNED WALLET CARD (Dynamic Background) -->
        <div class="wallet-card" id="main-wallet-card">
            <!-- Content Wrapper -->
            <div class="wallet-content">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <span class="balance-label"><i class="fas fa-wallet" style="margin-right: 5px;"></i> Available Balance</span>
                        <h1 class="balance-amount">‡ß≥ <span id="dash-balance">0</span></h1>
                    </div>
                    <!-- Decorative Chip Icon -->
                    <div class="card-chip">
                        <i class="fab fa-cc-visa"></i>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="display: flex; gap: 8px;">
                         <div class="user-info-pill"><i class="fas fa-id-card"></i> Ref: <span id="dash-refer">...</span></div>
                         <!-- NEW REFER COUNT IN CARD -->
                         <div class="user-info-pill"><i class="fas fa-users"></i> Team: <span id="dash-ref-count">0</span></div>
                    </div>
                    <i class="fas fa-wifi" style="transform: rotate(90deg); color: rgba(255,255,255,0.5);"></i>
                </div>
            </div>
        </div>

        <!-- Action Grid -->
        <h4 style="margin: 0 0 15px 20px; color: #444;">Quick Services</h4>
        <div class="action-grid">
            <div class="action-item" onclick="openProfile()">
                <div class="action-icon"><i class="fas fa-user-cog"></i></div>
                <span class="action-text">Profile</span>
            </div>
            <div class="action-item" onclick="openInvite()">
                <div class="action-icon"><i class="fas fa-share-alt"></i></div>
                <span class="action-text">Invite</span>
            </div>
             <div class="action-item" onclick="openWithdrawModal()">
                <div class="action-icon"><i class="fas fa-hand-holding-usd"></i></div>
                <span class="action-text">Withdraw</span>
            </div>
            <div class="action-item" onclick="openLeaderboard()">
                <div class="action-icon"><i class="fas fa-trophy"></i></div>
                <span class="action-text">Leaders</span>
            </div>
            <div class="action-item" onclick="openTeam()">
                <div class="action-icon"><i class="fas fa-users"></i></div>
                <span class="action-text">Team</span>
            </div>
            <div class="action-item" onclick="openSupport()">
                <div class="action-icon"><i class="fas fa-headset"></i></div>
                <span class="action-text">Support</span>
            </div>
        </div>

        <!-- Recent Activity Header -->
        <div style="padding: 0 20px;">
            <h4 style="color: #444; margin-bottom: 10px;">Recent Notice</h4>
            <div style="background: white; padding: 15px; border-radius: 15px; font-size: 12px; color: #666; border-left: 4px solid #1e3c72;">
                Invite friends and earn <b style="color: #1e3c72;">‡ß≥<span id="notice-bonus-amount">--</span></b> after their first deposit!
            </div>
        </div>
        
        <!-- BANNER AD PLACEMENT (DYNAMIC) -->
        <div style="text-align: center; margin: 20px 0;">
            <div id="banner-container" style="display: inline-block;">
                <span style="font-size: 10px; color: #ccc;">Ads</span>
            </div>
        </div>

    </div>

    <!-- 5. LEADERBOARD SCREEN (Dynamic Settings & Sticky Rank) -->
    <div id="leaderboard-screen" class="screen">
        <div class="header-nav">
            <i class="fas fa-arrow-left" onclick="goBack()" style="cursor: pointer;"></i>
            <span class="header-title">Ranking & Rewards</span>
            <div style="width: 20px;"></div>
        </div>

        <div class="tabs" style="margin-top: 15px;">
            <button class="tab-btn active" onclick="showLeaderTab('cards')">üéÅ Rewards</button>
            <button class="tab-btn" onclick="showLeaderTab('list')">üèÜ Top 20</button>
        </div>

        <!-- PREMIUM CARDS SECTION -->
        <div id="rewards-tab-content" style="padding: 0 20px; padding-bottom: 50px;">
            <h4 style="margin: 10px 0 15px 0; color: #444;">Exclusive Banner Cards</h4>
            <div id="cards-container">
                <p style="text-align: center; color: #999;">Loading Cards...</p>
            </div>
        </div>

        <!-- LEADERBOARD LIST SECTION -->
        <div id="leader-tab-content" style="display: none; margin-top: 10px;">
            <div id="leader-list" class="list-container leader-scroll-area">
                <p style="text-align: center; color: #999; margin-top: 50px;">Loading...</p>
            </div>
            
            <!-- STICKY MY RANK FOOTER -->
            <div id="my-rank-footer" class="sticky-rank-footer">
                <div style="display:flex; align-items:center;">
                    <div id="my-rank-circle" style="background: rgba(255,255,255,0.2); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; border: 2px solid rgba(255,255,255,0.5);">
                        #
                    </div>
                    <div>
                        <div style="font-size: 13px; font-weight: bold;">My Ranking</div>
                        <div style="font-size: 11px; opacity: 0.8;" id="my-rank-name">Loading...</div>
                    </div>
                </div>
                <div style="font-weight:bold; font-size: 16px;">
                    <span id="my-rank-count">0</span> Refs
                </div>
            </div>
        </div>
    </div>

    <!-- 6. TEAM SCREEN -->
    <div id="team-screen" class="screen">
        <div class="header-nav">
            <i class="fas fa-arrow-left" onclick="goBack()" style="cursor: pointer;"></i>
            <span class="header-title">My Team</span>
            <div style="width: 20px;"></div>
        </div>
        
        <!-- TEAM BANNER AD -->
        <div class="banner-box">
             <div id="team-banner-container" style="display: inline-block; width: 300px; height: 250px; background: #f0f2f5; display:flex; align-items:center; justify-content:center;">
                <span style="font-size: 10px; color: #ccc;">Ad Loading...</span>
            </div>
        </div>

        <div style="padding: 20px; text-align: center;">
            <p style="color: #666; font-size: 13px;">Your Refer Code</p>
            <h2 id="team-ref-code" onclick="copyText('team-ref-code')" style="color: #1e3c72; letter-spacing: 2px; cursor: pointer;" title="Click to copy">LOADING</h2>
        </div>
        <h4 style="margin: 10px 0 15px 20px; color: #444;">Referred Users</h4>
        <div id="team-list" class="list-container">
            <p style="text-align: center; color: #999; margin-top: 30px;">Loading team...</p>
        </div>
    </div>

    <!-- 7. PROFILE SCREEN -->
    <div id="profile-screen" class="screen">
        <div class="header-nav">
            <i class="fas fa-arrow-left" onclick="goBack()" style="cursor: pointer;"></i>
            <span class="header-title">My Profile</span>
            <div style="width: 20px;"></div>
        </div>

        <div class="profile-header">
            <div class="profile-avatar"><i class="fas fa-user"></i></div>
            <h3 id="profile-name">User Name</h3>
            <p id="profile-phone" style="font-size: 13px; color: #888;">01700000000</p>
            <p id="profile-email" style="font-size: 13px; color: #888;">user@mail.com</p>
        </div>

        <!-- Password Change Section -->
        <div style="padding: 0 20px; margin-bottom: 20px;">
            <button class="btn-outline" onclick="toggleElement('pass-change-form')"><i class="fas fa-key"></i> Change Password</button>
            <div id="pass-change-form" style="display: none; margin-top: 15px; background: white; padding: 15px; border-radius: 15px;">
                <div class="input-group">
                    <i class="fas fa-lock fa-icon"></i>
                    <input type="password" id="old-pass" placeholder="Old Password">
                </div>
                <div class="input-group" style="margin-bottom: 5px;">
                    <i class="fas fa-lock fa-icon"></i>
                    <input type="password" id="new-pass" placeholder="New Password">
                </div>
                <button class="btn-main" id="btn-change-pass" onclick="changeUserPassword()">Update Password</button>
            </div>
        </div>
        
        <!-- PROFILE BANNER AD -->
        <div class="banner-box">
             <div id="profile-banner-container" style="display: inline-block; width: 300px; height: 250px; background: #f0f2f5; display:flex; align-items:center; justify-content:center;">
                <span style="font-size: 10px; color: #ccc;">Ad Loading...</span>
            </div>
        </div>

        <!-- History Section -->
        <h4 style="margin: 0 0 10px 20px; color: #444;">Transaction History</h4>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchHistory('deposit')">Deposit</button>
            <button class="tab-btn" onclick="switchHistory('withdraw')">Withdraw</button>
        </div>
        
        <div id="history-list" class="list-container">
            <!-- Content loaded via JS -->
            <p style="text-align: center; color: #999;">Loading...</p>
        </div>
    </div>

    <!-- 8. INVITE SCREEN -->
    <div id="invite-screen" class="screen">
        <div class="header-nav">
            <i class="fas fa-arrow-left" onclick="goBack()" style="cursor: pointer;"></i>
            <span class="header-title">Invite Friends</span>
            <div style="width: 20px;"></div>
        </div>

        <div style="padding: 30px 20px; text-align: center;">
            
            <!-- NEW AD BANNER PLACEHOLDER -->
            <div id="invite-banner-container" style="display: inline-block; width: 300px; height: 250px; background: #f0f2f5; margin-bottom: 20px; display:flex; align-items:center; justify-content:center;">
                <span style="font-size: 10px; color: #ccc;">Ad Loading...</span>
            </div>
            
            <h3 style="color: #1e3c72;">Refer & Earn</h3>
            <p style="color: #666; font-size: 13px; margin: 10px 0 20px 0;">
                Share your link and earn <b style="color:#1e3c72;">‡ß≥<span id="invite-bonus-amount">--</span></b> after their first deposit!
            </p>

            <!-- Referral Link -->
            <div style="text-align: left;">
                <label style="font-size: 12px; color: #888; margin-left: 5px;">Referral Link</label>
                <div class="copy-box">
                    <span id="invite-link" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">Loading...</span>
                    <i class="fas fa-copy" onclick="copyText('invite-link')" style="color: #1e3c72; cursor: pointer; padding: 5px;" title="Copy Link"></i>
                </div>
            </div>

            <!-- Referral Code -->
            <div style="text-align: left; margin-top: 15px;">
                <label style="font-size: 12px; color: #888; margin-left: 5px;">Referral Code</label>
                <div class="copy-box">
                    <span id="invite-code" style="font-weight: bold; letter-spacing: 1px;">...</span>
                    <i class="fas fa-copy" onclick="copyText('invite-code')" style="color: #1e3c72; cursor: pointer; padding: 5px;" title="Copy Code"></i>
                </div>
            </div>

            <!-- Share Button -->
            <button class="btn-main" onclick="shareInvite()" style="margin-top: 20px; background: #2ecc71;">
                <i class="fas fa-share-nodes"></i> Share Now (WhatsApp/More)
            </button>

            <!-- Download App Button (Linked to Admin) -->
            <div style="margin-top: 20px;">
                <button class="btn-outline" id="btn-dl-app" onclick="downloadApp()" style="display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;">
                    <i class="fab fa-android" style="font-size: 20px;"></i> Download App (APK)
                </button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- Support Modal -->
    <div id="support-modal" class="modal">
        <div class="modal-content">
            <i class="fas fa-headset" style="font-size: 40px; color: #1e3c72; margin-bottom: 15px;"></i>
            <h3>Help Center</h3>
            <p style="font-size: 12px; color: #777; margin-bottom: 20px;">How can we help you?</p>
            
            <button class="btn-main" onclick="openTelegram()" style="background: #229ED9; margin-bottom: 10px;">
                <i class="fab fa-telegram-plane"></i> Join Channel
            </button>
            <button class="btn-text" onclick="closeModal('support-modal')">Close</button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3>Withdraw Money</h3>
            <p style="font-size: 12px; color: #888;">Minimum limit: ‡ß≥200</p>
            <div style="margin-top: 20px; text-align: left;">
                <input type="number" id="w-amount" placeholder="Amount (Numbers only)" 
                       style="margin-bottom: 10px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                
                <input type="number" id="w-method" placeholder="Bkash/Nagad Number" 
                       style="margin-bottom: 10px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">

                <div class="input-group" style="margin-bottom: 0;">
                    <i class="fas fa-lock fa-icon"></i>
                    <input type="password" id="w-pass" placeholder="Confirm Password">
                </div>
            </div>
            <button class="btn-main" id="btn-withdraw" onclick="processWithdraw()">Confirm Request</button>
            <button class="btn-text" onclick="closeModal('withdraw-modal')">Cancel</button>
        </div>
    </div>

    <!-- POPUP AD MODAL (With Timer) -->
    <div id="ad-popup-modal" class="modal">
        <div class="ad-modal-content">
            <div class="close-ad-btn" onclick="closeModal('ad-popup-modal')">‚úï</div>
            <!-- Ad Container inside Modal -->
            <div id="home-popup-container"></div>
            <p id="ad-timer-text" style="font-size:10px; color:#999; margin-top:5px;">Please wait...</p>
        </div>
    </div>

</div>

<!-- FIREBASE REALTIME DATABASE LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, update, onValue, get, child, push, query, orderByChild, equalTo, limitToLast, startAt, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
            apiKey: "AIzaSyD9Umavm907AQdAFqYXT4wotrTuqi2nh3s",
            authDomain: "pro-68344-default-rtdb.firebaseio.com",
            projectId: "pro-68344",
            storageBucket: "pro-68344.firebasestorage.app",
            messagingSenderId: "220248111668",
            appId: "1:220248111668:android:c692486c4f471c256d2861",
            databaseURL: "https://pro-68344-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUserData = null;
    let userUnsubscribe = null; 
    let pendingAutoDownload = false; 
    let homeAdShown = false; 
    
    // Global Variables
    let adminDepositNumber = "LOADING...";
    let adminDepositAmount = 500; 
    let adminReferBonus = 0; 
    let adminTelegramLink = "https://t.me/"; 
    let appDownloadUrl = "#"; 

    // --- DYNAMIC CARD SETTINGS (Admin Controlled) ---
    // Default Fallback
    let adminCardSettings = {
        c1: { target: 20, reward: 50 },
        c2: { target: 50, reward: 100 },
        c3: { target: 100, reward: 200 },
        c4: { target: 200, reward: 500 },
        c5: { target: 500, reward: 1000 }
    };

    // --- DYNAMIC ADS VARIABLES ---
    let adBannerKey = ""; 
    let adPopunderUrl = ""; 

    // --- HELPER: ERROR MESSAGES ---
    function getFriendlyError(error) {
        const code = error.code;
        if(code === 'auth/user-not-found' || code === 'auth/wrong-password' || code === 'auth/invalid-credential') return "Invalid Email or Password.";
        if(code === 'auth/email-already-in-use') return "Email is already registered.";
        if(code === 'auth/invalid-email') return "Please enter a valid email address.";
        if(code === 'auth/weak-password') return "Password must be at least 6 characters.";
        if(code === 'auth/network-request-failed') return "Network error. Check your connection.";
        if(code === 'auth/too-many-requests') return "Too many attempts. Please try again later.";
        return "An error occurred. Please try again.";
    }

    // --- INITIALIZE ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        
        if(refParam) {
            localStorage.setItem('saved_ref_code', refParam);
            pendingAutoDownload = true;
            const refInput = document.getElementById('final-refer-code');
            if(refInput) {
                refInput.value = refParam;
                refInput.style.backgroundColor = "#e8f0fe"; 
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW Registered!', reg))
            .catch(err => console.log('SW Error:', err));
        }
        
        history.pushState({ screen: 'init' }, document.title, window.location.href);
    }

    // --- INTERNET CHECK LOGIC (UPDATED) ---
    window.updateOnlineStatus = () => {
        const noNetScreen = document.getElementById('no-internet');
        if (!navigator.onLine) {
            noNetScreen.style.display = 'flex';
        } else {
            noNetScreen.style.display = 'none';
        }
    }

    // NEW FUNCTION: Manual Check without Reload
    window.checkInternetManual = () => {
        const btn = document.getElementById('btn-retry-net');
        const originalText = btn.innerText;
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        btn.disabled = true;

        setTimeout(() => {
            if (navigator.onLine) {
                window.updateOnlineStatus(); // Hides screen if online
            } else {
                alert("Still Offline. Please check WiFi/Data.");
            }
            // Reset button
            btn.innerText = originalText;
            btn.disabled = false;
        }, 1500); // 1.5s delay to simulate checking
    }

    window.addEventListener('online', window.updateOnlineStatus);
    window.addEventListener('offline', window.updateOnlineStatus);
    window.updateOnlineStatus();

    // --- ADMIN SETTINGS & CARDS ---
    // Fetch General Settings
    onValue(ref(db, 'admin/settings'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
            if (data.maintenance === true) document.getElementById('maintenance-page').style.display = 'flex';
            else document.getElementById('maintenance-page').style.display = 'none';
            
            if (data.app_link) {
                appDownloadUrl = data.app_link;
                if (pendingAutoDownload && appDownloadUrl !== "#") {
                    window.location.href = appDownloadUrl;
                    pendingAutoDownload = false; 
                }
            }
            if (data.telegram_link) adminTelegramLink = data.telegram_link;
            if (data.payment_number) {
                adminDepositNumber = data.payment_number;
                document.getElementById('display-dep-number').innerText = adminDepositNumber;
            }
            if (data.deposit_amount) {
                adminDepositAmount = parseInt(data.deposit_amount);
                document.getElementById('display-dep-amount').innerText = adminDepositAmount;
            }
            if (data.referral_bonus) {
                adminReferBonus = parseInt(data.referral_bonus);
                document.getElementById('invite-bonus-amount').innerText = adminReferBonus;
                document.getElementById('notice-bonus-amount').innerText = adminReferBonus;
            }
        }
    });

    // Fetch Card Settings (New Requirement)
    onValue(ref(db, 'admin/card_settings'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
            adminCardSettings = data; // Update local config with admin data
            // If user is already loaded, update their card UI
            if(currentUserData) {
                updateWalletDesign(currentUserData.refCount || 0);
            }
        }
    });

    // --- DYNAMIC ADS LOGIC ---
    onValue(ref(db, 'admin/ads'), (snapshot) => {
        const adData = snapshot.val();
        if (adData) {
            if (adData.banner_key && adData.banner_key !== adBannerKey) {
                adBannerKey = adData.banner_key;
                loadBannerAd(adBannerKey);
            }
            if (adData.popunder_url) {
                adPopunderUrl = adData.popunder_url;
            }
        }
    });

    function loadBannerAd(key) {
        const adContainers = ['banner-container', 'invite-banner-container', 'profile-banner-container', 'team-banner-container'];

        adContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (!container || !key) return;
            container.innerHTML = '';
            createAdIframe(container, key);
        });
    }
    
    function createAdIframe(container, key) {
        const iframe = document.createElement('iframe');
        iframe.style.width = "300px";
        iframe.style.height = "250px";
        iframe.style.border = "none";
        iframe.style.overflow = "hidden";
        iframe.scrolling = "no";
        container.appendChild(iframe);

        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
            <html>
            <body style="margin:0;padding:0;text-align:center;">
                <script type="text/javascript">
                    atOptions = {
                        'key' : '${key}',
                        'format' : 'iframe',
                        'height' : 250,
                        'width' : 300,
                        'params' : {}
                    };
                <\/script>
                <script type="text/javascript" src="https://www.highperformanceformat.com/${key}/invoke.js"><\/script>
            </body>
            </html>
        `);
        doc.close();
    }

    window.triggerAd = () => {
        if (!adPopunderUrl) return;
        if(document.querySelector(`script[src="${adPopunderUrl}"]`)) return;
        const script = document.createElement('script');
        script.src = adPopunderUrl;
        script.async = true;
        document.body.appendChild(script);
        console.log("Popunder Triggered");
    };
    
    function showHomePopupAd() {
        if(!adBannerKey) return;
        const modal = document.getElementById('ad-popup-modal');
        const container = document.getElementById('home-popup-container');
        const closeBtn = document.querySelector('.close-ad-btn');
        const timerText = document.getElementById('ad-timer-text');
        
        container.innerHTML = ''; 
        createAdIframe(container, adBannerKey);
        
        closeBtn.style.display = 'none';
        timerText.style.display = 'block';
        modal.style.display = 'block';

        setTimeout(() => {
            closeBtn.style.display = 'flex'; 
            timerText.style.display = 'none'; 
        }, 5000);
    }

    // --- UTILITIES ---
    window.togglePass = (id) => {
        const input = document.getElementById(id);
        input.type = input.type === "password" ? "text" : "password";
    }

    window.toggleElement = (id) => {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    const setLoading = (btnId, loading, text = "Processing...") => {
        const btn = document.getElementById(btnId);
        if(!btn) return;
        if(loading) {
            if (!btn.dataset.original) btn.dataset.original = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
        } else {
            btn.disabled = false;
            btn.innerText = btn.dataset.original || "Submit";
        }
    };

    window.copyText = (elementId) => {
        const text = document.getElementById(elementId).innerText;
        if(text === "..." || text === "LOADING") return;
        navigator.clipboard.writeText(text).then(() => {
            alert("Copied to clipboard!");
        });
    };

    // --- NAVIGATION ---
    window.showLogin = () => { document.getElementById('login-box').style.display = 'block'; document.getElementById('reg-box').style.display = 'none'; }
    window.showReg = () => { document.getElementById('login-box').style.display = 'none'; document.getElementById('reg-box').style.display = 'block'; }
    
    window.showScreen = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
        if(id !== 'dashboard-screen' && id !== 'auth-screen') {
            history.pushState({ screen: id }, null, window.location.href);
        }
    };
    
    window.goBack = () => { window.history.back(); };

    window.addEventListener('popstate', (event) => {
        const supportModal = document.getElementById('support-modal');
        const withdrawModal = document.getElementById('withdraw-modal');
        const adModal = document.getElementById('ad-popup-modal');
        const closeBtn = document.querySelector('.close-ad-btn');

        if (supportModal.style.display === 'block') { closeModal('support-modal'); return; }
        if (withdrawModal.style.display === 'block') { closeModal('withdraw-modal'); return; }
        if (adModal.style.display === 'block') { 
            if(closeBtn.style.display !== 'none') { closeModal('ad-popup-modal'); }
            return; 
        }

        const currentScreen = document.querySelector('.screen.active-screen');
        if (currentScreen && currentScreen.id !== 'dashboard-screen' && currentScreen.id !== 'auth-screen' && currentScreen.id !== 'refer-screen' && currentScreen.id !== 'pending-screen' && currentScreen.id !== 'deposit-screen') {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('dashboard-screen').classList.add('active-screen');
        } 
    });
    
    window.openSupport = () => { triggerAd(); document.getElementById('support-modal').style.display = 'block'; history.pushState({ modal: 'support' }, null, window.location.href); }
    window.openWithdrawModal = () => { triggerAd(); document.getElementById('withdraw-modal').style.display = 'block'; history.pushState({ modal: 'withdraw' }, null, window.location.href); }
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // --- AUTH & USER LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            if(userUnsubscribe) { userUnsubscribe(); }
            const userRef = ref(db, 'users/' + user.uid);
            userUnsubscribe = onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentUserData = data;
                    if (currentUserData.isBlocked) {
                        document.getElementById('blocked-page').style.display = 'flex';
                        setLoading('btn-login', false);
                        return;
                    } else {
                        document.getElementById('blocked-page').style.display = 'none';
                    }
                    localStorage.setItem('pro_wallet_device_id', user.uid);
                    handleUserStatus(currentUserData);
                    setLoading('btn-login', false);
                }
            });
        } else {
            showScreen('auth-screen');
            const loginBtn = document.getElementById('btn-login');
            if(loginBtn) { setLoading('btn-login', false); loginBtn.innerText = "Login"; }
        }
    });

    function handleUserStatus(data) {
        if (!data.referredBy || data.referredBy === "") {
            showScreen('refer-screen');
            const savedRef = localStorage.getItem('saved_ref_code');
            if(savedRef) { document.getElementById('final-refer-code').value = savedRef; document.getElementById('final-refer-code').style.backgroundColor = "#e8f0fe"; }
            return;
        }
        if (data.status === 'active') {
            document.getElementById('dash-balance').innerText = data.balance || 0;
            document.getElementById('dash-name').innerText = data.name;
            document.getElementById('dash-refer').innerText = data.referCode;
            // UPDATE: Show total refs inside the wallet card
            document.getElementById('dash-ref-count').innerText = data.refCount || 0;

            // UPDATE: Change wallet design based on progress
            updateWalletDesign(data.refCount || 0);

            showScreen('dashboard-screen');
            
            if (!homeAdShown) {
                setTimeout(triggerAd, 2000);
                if(adBannerKey) { setTimeout(showHomePopupAd, 1500); }
                homeAdShown = true;
            }
            return;
        } 
        if (!data.paymentInfo) { showScreen('deposit-screen'); } else { showScreen('pending-screen'); }
    }

    // --- NEW: UPDATE WALLET DESIGN LOGIC ---
    function updateWalletDesign(refCount) {
        const card = document.getElementById('main-wallet-card');
        // Reset classes but keep base 'wallet-card'
        card.className = 'wallet-card';

        // Check against Admin Settings targets (Highest to Lowest)
        if (refCount >= adminCardSettings.c5.target) { card.classList.add('bg-diamond'); }
        else if (refCount >= adminCardSettings.c4.target) { card.classList.add('bg-platinum'); }
        else if (refCount >= adminCardSettings.c3.target) { card.classList.add('bg-gold'); }
        else if (refCount >= adminCardSettings.c2.target) { card.classList.add('bg-silver'); }
        else if (refCount >= adminCardSettings.c1.target) { card.classList.add('bg-bronze'); }
        // Default stays blue gradient defined in css .wallet-card
    }

    window.registerUser = async () => {
        const existingDevice = localStorage.getItem('pro_wallet_device_id');
        if (existingDevice) { alert("Account Limit Reached!"); return; }
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        const phone = document.getElementById('reg-phone').value;

        if(!name || !email || !pass || !phone) { alert("Fill all fields"); return; }
        setLoading('btn-reg', true, "Creating...");
        try {
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            const myReferCode = (name.substring(0,3) + phone.slice(-4)).toUpperCase();
            await set(ref(db, 'users/' + cred.user.uid), {
                name, email, phone, uid: cred.user.uid,
                balance: 0, status: 'pending', referCode: myReferCode, 
                referredBy: "", refCount: 0, isBlocked: false, createdAt: Date.now()
            });
            localStorage.setItem('pro_wallet_device_id', cred.user.uid);
        } catch (e) { alert(getFriendlyError(e)); setLoading('btn-reg', false); }
    };

    window.submitReferCode = async () => {
        const codeInput = document.getElementById('final-refer-code').value.trim().toUpperCase();
        if(!codeInput) { alert("Please enter a code"); return; }
        if(codeInput === currentUserData.referCode) { alert("You cannot refer yourself!"); return; }
        setLoading('btn-verify-ref', true, "Verifying...");
        try {
            const usersRef = ref(db, 'users');
            const q = query(usersRef, orderByChild('referCode'), equalTo(codeInput));
            const snapshot = await get(q);
            if (!snapshot.exists()) { throw new Error("Invalid Referral Code!"); }
            await update(ref(db, 'users/' + auth.currentUser.uid), { referredBy: codeInput });
            localStorage.removeItem('saved_ref_code');
        } catch (e) { alert(e.message); } finally { setLoading('btn-verify-ref', false, "Verify & Continue"); }
    }

    window.loginUser = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(!email || !pass) return;
        setLoading('btn-login', true);
        try { await signInWithEmailAndPassword(auth, email, pass); } 
        catch (e) { document.getElementById('auth-msg').innerText = getFriendlyError(e); setLoading('btn-login', false); }
    };

    window.logout = () => signOut(auth);

    window.submitPayment = async () => {
        const method = document.getElementById('pay-method').value;
        const num = document.getElementById('pay-number').value;
        const trx = document.getElementById('pay-trx').value;
        if(!method || !num || !trx) { alert("Fill all details"); return; }
        const pInfo = { method, sender: num, trxID: trx, amount: adminDepositAmount, time: new Date().toDateString() };
        await update(ref(db, 'users/' + auth.currentUser.uid), { paymentInfo: pInfo });
        const newDepRef = push(ref(db, 'deposits'));
        await set(newDepRef, { ...pInfo, uid: auth.currentUser.uid, status: 'pending' });
    };

    // --- LEADERBOARD & CARDS LOGIC ---
    window.showLeaderTab = (tab) => {
        const cardTab = document.getElementById('rewards-tab-content');
        const listTab = document.getElementById('leader-tab-content');
        const btns = document.querySelectorAll('.tabs .tab-btn');
        if (tab === 'cards') {
            cardTab.style.display = 'block'; listTab.style.display = 'none';
            btns[0].classList.add('active'); btns[1].classList.remove('active');
        } else {
            cardTab.style.display = 'none'; listTab.style.display = 'block';
            btns[0].classList.remove('active'); btns[1].classList.add('active');
            loadLeaderboardList(); 
        }
    };

    window.openLeaderboard = async () => {
        showScreen('leaderboard-screen');
        window.showLeaderTab('cards');
        renderGiftCards();
    };

    // UPDATED: Use Admin Settings to Render Cards
    function renderGiftCards() {
        const container = document.getElementById('cards-container');
        const myRefs = currentUserData.refCount || 0;
        const myClaims = currentUserData.claims || {};

        // Configuration Map using Admin Data
        const cardConfig = [
            { id: 'c1', name: 'Bronze Starter', icon: 'fa-medal', class: 'bg-bronze' },
            { id: 'c2', name: 'Silver Elite', icon: 'fa-trophy', class: 'bg-silver' },
            { id: 'c3', name: 'Gold Master', icon: 'fa-crown', class: 'bg-gold' },
            { id: 'c4', name: 'Platinum Pro', icon: 'fa-gem', class: 'bg-platinum' },
            { id: 'c5', name: 'Diamond King', icon: 'fa-star', class: 'bg-diamond' }
        ];

        let html = '';
        
        cardConfig.forEach(card => {
            const settings = adminCardSettings[card.id]; // Get Target & Reward
            const target = settings ? settings.target : 999;
            const reward = settings ? settings.reward : 0;
            
            const isLocked = myRefs < target;
            const claimStatus = myClaims[card.id] || null; 
            
            let btnHtml = '';
            if (isLocked) {
                btnHtml = `<button class="btn-card-action locked"><i class="fas fa-lock"></i> Locked</button>`;
            } else {
                if (!claimStatus) {
                    btnHtml = `<button class="btn-card-action" onclick="claimCard('${card.id}', '${card.name}')">Claim</button>`;
                } else if (claimStatus === 'pending') {
                    btnHtml = `<button class="btn-card-action pending"><i class="fas fa-clock"></i> Wait...</button>`;
                } else {
                    btnHtml = `<button class="btn-card-action done"><i class="fas fa-check"></i> Done</button>`;
                }
            }

            html += `
            <div class="gift-card ${card.class}">
                <i class="fas ${card.icon} card-bg-icon"></i>
                <div class="gift-content">
                    <div>
                        <div class="gift-title">${card.name}</div>
                        <div class="gift-subtitle">Reward: ‡ß≥${reward}</div>
                        <div class="card-badge">
                            ${myRefs}/${target} Friends
                        </div>
                    </div>
                    <div>${btnHtml}</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    window.claimCard = async (cardId, cardName) => {
        if (!confirm(`Apply for ${cardName} reward?`)) return;
        try {
            await update(ref(db, 'users/' + auth.currentUser.uid + '/claims'), { [cardId]: 'pending' });
            await push(ref(db, 'gift_requests'), {
                uid: auth.currentUser.uid,
                name: currentUserData.name,
                cardId: cardId,
                cardName: cardName,
                refCount: currentUserData.refCount,
                date: Date.now(),
                status: 'pending'
            });
            alert("Application Submitted! Admin will check and send your gift.");
            renderGiftCards(); 
        } catch (e) { alert("Error: " + e.message); }
    };

    const getRankIcon = (count) => {
        if(count >= adminCardSettings.c5.target) return '<i class="fas fa-star" style="color:#8E2DE2; margin-right:5px;" title="Diamond"></i>';
        if(count >= adminCardSettings.c4.target) return '<i class="fas fa-gem" style="color:#00c6ff; margin-right:5px;" title="Platinum"></i>';
        if(count >= adminCardSettings.c3.target) return '<i class="fas fa-crown" style="color:#f1c40f; margin-right:5px;" title="Gold"></i>';
        if(count >= adminCardSettings.c2.target) return '<i class="fas fa-trophy" style="color:#7f8c8d; margin-right:5px;" title="Silver"></i>';
        if(count >= adminCardSettings.c1.target) return '<i class="fas fa-medal" style="color:#cd7f32; margin-right:5px;" title="Bronze"></i>';
        return '';
    };

    // --- UPDATED LEADERBOARD LIST LOGIC (FIXED) ---
    async function loadLeaderboardList() {
        const list = document.getElementById('leader-list');
        const footer = document.getElementById('my-rank-footer');
        
        list.innerHTML = '<p style="text-align:center; margin-top:20px;">Loading Top 20...</p>';
        footer.style.display = 'none';

        try {
            // 1. Fetch ALL users (Bulletproof method)
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);

            if (!snapshot.exists()) {
                list.innerHTML = '<p style="text-align:center;">No users found.</p>';
                return;
            }

            // 2. Convert to array and handle missing refCount
            let allUsers = [];
            snapshot.forEach((child) => {
                const u = child.val();
                if (!u.refCount) u.refCount = 0; // Default to 0 if undefined
                allUsers.push(u);
            });

            // 3. Sort Client-Side (Highest first)
            allUsers.sort((a, b) => b.refCount - a.refCount);

            // 4. Find My Rank
            const myUid = auth.currentUser.uid;
            const myIndex = allUsers.findIndex(u => u.uid === myUid);
            const myRank = myIndex + 1; 
            const myData = allUsers[myIndex];

            // 5. Slice Top 20
            const top20Users = allUsers.slice(0, 20);

            // 6. Render List
            let html = '';
            let rank = 1;

            top20Users.forEach(u => {
                const count = u.refCount || 0;
                const rankIcon = getRankIcon(count);
                
                // Highlight Me
                const isMe = u.uid === myUid;
                const bgStyle = isMe ? 'background: #e8f0fe; border:1px solid #1e3c72;' : '';

                html += `<div class="list-item" style="${bgStyle}">
                    <div style="display:flex;align-items:center;">
                        <div class="rank-badge">${rank++}</div>
                        <div style="margin-left:15px;">
                            <div style="font-weight:600; display:flex; align-items:center;">
                                ${rankIcon} ${u.name}
                            </div>
                            <div style="font-size:11px;color:#888;">${u.referCode}</div>
                        </div>
                    </div>
                    <div style="font-weight:bold;color:#1e3c72;">${count} Refs</div>
                </div>`;
            });

            list.innerHTML = html;

            // 7. Update Sticky Footer
            if (myData) {
                document.getElementById('my-rank-circle').innerText = myRank;
                document.getElementById('my-rank-name').innerText = myData.name;
                document.getElementById('my-rank-count').innerText = myData.refCount;
                footer.style.display = 'flex';
            }

        } catch (e) { 
            console.error(e);
            list.innerHTML = '<p style="text-align:center; color:red;">Error loading list.</p>'; 
        }
    }

    // --- TEAM, PROFILE, HISTORY (Existing Logic) ---
    window.openTeam = async () => {
        showScreen('team-screen');
        if(adBannerKey) loadBannerAd(adBannerKey);
        document.getElementById('team-ref-code').innerText = currentUserData.referCode;
        const list = document.getElementById('team-list');
        list.innerHTML = "Loading...";
        const q = query(ref(db, 'users'), orderByChild('referredBy'), equalTo(currentUserData.referCode));
        const snapshot = await get(q);
        if(!snapshot.exists()) { list.innerHTML = '<p style="text-align:center;">No members.</p>'; return; }
        let html = '';
        snapshot.forEach(d => {
            const m = d.val();
            const statusColor = m.status === 'active' ? 'green' : 'orange';
            html += `<div class="list-item">
                <div style="display:flex;align-items:center;">
                    <div class="list-icon team-icon"><i class="fas fa-user"></i></div>
                    <div><div style="font-weight:600;">${m.name}</div><div style="font-size:12px; color:${statusColor}">${m.status.toUpperCase()}</div></div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    };

    window.openInvite = () => {
        showScreen('invite-screen');
        const code = currentUserData.referCode;
        let baseUrl = window.location.origin + window.location.pathname;
        const link = baseUrl + '?ref=' + code;
        document.getElementById('invite-code').innerText = code;
        document.getElementById('invite-link').innerText = link;
    }

    window.shareInvite = async () => {
        const link = document.getElementById('invite-link').innerText;
        const code = document.getElementById('invite-code').innerText;
        const shareData = { title: 'Pro Wallet', text: `Join & Earn! Code: ${code} \nLink: ${link}`, url: link };
        if (navigator.share) { try { await navigator.share(shareData); } catch (err) { console.log('Error sharing:', err); } } 
        else { copyText('invite-link'); alert("Link copied!"); }
    }

    window.openProfile = () => {
        showScreen('profile-screen');
        if(adBannerKey) loadBannerAd(adBannerKey);
        document.getElementById('profile-name').innerText = currentUserData.name;
        document.getElementById('profile-email').innerText = currentUserData.email;
        document.getElementById('profile-phone').innerText = currentUserData.phone;
        document.getElementById('pass-change-form').style.display = 'none';
        window.switchHistory('deposit');
    }

    window.changeUserPassword = async () => {
        const oldPass = document.getElementById('old-pass').value;
        const newPass = document.getElementById('new-pass').value;
        if(!oldPass || !newPass || newPass.length < 6) { alert("Invalid input"); return; }
        setLoading('btn-change-pass', true);
        try {
            const credential = EmailAuthProvider.credential(auth.currentUser.email, oldPass);
            await reauthenticateWithCredential(auth.currentUser, credential);
            await updatePassword(auth.currentUser, newPass);
            alert("Password Changed! Login again."); signOut(auth);
        } catch (e) { alert(getFriendlyError(e)); setLoading('btn-change-pass', false); }
    }

    window.switchHistory = async (type) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const list = document.getElementById('history-list');
        list.innerHTML = '<p style="text-align:center;">Loading...</p>';
        try {
            let html = '';
            if (type === 'withdraw') {
                const q = query(ref(db, 'withdraw_requests'), orderByChild('uid'), equalTo(auth.currentUser.uid));
                const snap = await get(q);
                if(snap.exists()) {
                    let items = []; snap.forEach(c => items.push(c.val()));
                    items.reverse().forEach(i => {
                        const date = i.requestDate ? new Date(i.requestDate).toLocaleDateString() : 'Recent';
                        html += `<div class="list-item">
                            <div style="display:flex;align-items:center;">
                                <div class="list-icon withdraw-icon"><i class="fas fa-arrow-up"></i></div>
                                <div><div style="font-weight:600;">Withdraw</div><div style="font-size:11px;color:#666;">${i.method} (${date})</div></div>
                            </div>
                            <div style="text-align:right;"><div style="font-weight:bold;color:#e74c3c;">-‡ß≥${i.amount}</div><div style="font-size:11px;color:#888;">${i.status.toUpperCase()}</div></div>
                        </div>`;
                    });
                } else html = '<p style="text-align:center; color:#999; margin-top:20px;">No withdrawals yet.</p>';
            } else { 
                const q = query(ref(db, 'deposits'), orderByChild('uid'), equalTo(auth.currentUser.uid));
                const snap = await get(q);
                if(snap.exists()) {
                    let items = []; snap.forEach(c => items.push(c.val()));
                    items.reverse().forEach(i => {
                        html += `<div class="list-item">
                            <div style="display:flex;align-items:center;">
                                <div class="list-icon deposit-icon"><i class="fas fa-arrow-down"></i></div>
                                <div><div style="font-weight:600;">Deposit</div><div style="font-size:12px;">${i.method}</div></div>
                            </div>
                            <div style="text-align:right;"><div style="font-weight:bold;color:#2ecc71;">+‡ß≥${i.amount}</div><div style="font-size:11px;color:#888;">${i.status || 'Success'}</div></div>
                        </div>`;
                    });
                } else {
                     if(currentUserData.paymentInfo) {
                        const p = currentUserData.paymentInfo;
                        html = `<div class="list-item"><div style="display:flex;align-items:center;"><div class="list-icon deposit-icon"><i class="fas fa-arrow-down"></i></div><div><div style="font-weight:600;">Deposit</div><div style="font-size:12px;">${p.method}</div></div></div><div style="text-align:right;"><div style="font-weight:bold;color:#2ecc71;">+‡ß≥${p.amount}</div><div style="font-size:11px;color:#888;">Initial</div></div></div>`;
                     } else { html = '<p style="text-align:center; color:#999; margin-top:20px;">No deposits found.</p>'; }
                }
            }
            list.innerHTML = html;
        } catch(e) { console.error(e); list.innerHTML = "Error loading history."; }
    }

    window.processWithdraw = async () => {
        const amountStr = document.getElementById('w-amount').value;
        const method = document.getElementById('w-method').value;
        const pass = document.getElementById('w-pass').value;

        if (!/^\d+$/.test(amountStr)) { alert("Amount must be a number"); return; }
        const amount = parseInt(amountStr);
        if(amount < 200) { alert("Minimum 200 Taka"); return; }
        if(currentUserData.balance < amount) { alert("Insufficient Balance"); return; }
        if(!method || !pass) { alert("Fill all fields"); return; }

        setLoading('btn-withdraw', true);
        try {
            const credential = EmailAuthProvider.credential(auth.currentUser.email, pass);
            await reauthenticateWithCredential(auth.currentUser, credential);
            const balanceRef = ref(db, 'users/' + auth.currentUser.uid + '/balance');
            await runTransaction(balanceRef, (bal) => (bal >= amount ? bal - amount : undefined));
            await push(ref(db, 'withdraw_requests'), { uid: auth.currentUser.uid, amount, method, status: 'pending', requestDate: Date.now() });
            alert("Request Submitted!");
            closeModal('withdraw-modal');
            document.getElementById('w-pass').value = '';
            if(document.getElementById('profile-screen').classList.contains('active-screen')) { window.switchHistory('withdraw'); }
        } catch(e) { alert(getFriendlyError(e)); } 
        finally { setLoading('btn-withdraw', false); }
    };
</script>

</body>
</html>